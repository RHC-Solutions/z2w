{% extends "base.html" %}
{% block title %}Logs{% if slug %} — {{ slug }}{% endif %}{% endblock %}
{% block page_title %}Logs{% endblock %}
{% block page_sub %}Application log viewer · {{ selected_date }}{% endblock %}

{% block topbar_actions %}
<form method="GET" action="" style="display:flex;align-items:center;gap:8px;flex-wrap:wrap">
  <select name="date" class="form-select" style="height:30px;font-size:12px;width:auto"
          onchange="this.form.submit()">
    {% for d in available_dates %}
    <option value="{{ d }}" {% if d == selected_date %}selected{% endif %}>{{ d }}</option>
    {% endfor %}
  </select>
  <select name="level" class="form-select" style="height:30px;font-size:12px;width:auto"
          onchange="this.form.submit()">
    <option value="" {% if not level_filter %}selected{% endif %}>All levels</option>
    {% for lv in ['DEBUG','INFO','WARNING','ERROR','CRITICAL'] %}
    <option value="{{ lv }}" {% if level_filter == lv %}selected{% endif %}>
      {{ lv }}{% if level_counts.get(lv) %} ({{ level_counts[lv] }}){% endif %}
    </option>
    {% endfor %}
  </select>
  <input type="text" name="q" value="{{ search_q or '' }}"
         class="form-control" placeholder="Search…"
         style="height:30px;font-size:12px;max-width:200px">
  <input type="hidden" name="page" value="1">
  <button type="submit" class="btn btn-primary btn-sm">Filter</button>
  <a href="?" class="btn btn-outline btn-sm">Clear</a>
</form>
{% endblock %}

{% block content %}

<div style="display:flex;gap:8px;align-items:center;margin-bottom:14px;flex-wrap:wrap">
  <span style="font-size:12px;color:var(--muted-foreground)">{{ total }} entr{{ 'y' if total == 1 else 'ies' }}
    {% if level_filter %} · <strong>{{ level_filter }}</strong> only{% endif %}
    {% if search_q %} · matching <strong>{{ search_q }}</strong>{% endif %}
  </span>
  {% if level_counts.get('ERROR') or level_counts.get('CRITICAL') %}
  <span class="badge badge-danger">
    {{ (level_counts.get('ERROR') or 0) + (level_counts.get('CRITICAL') or 0) }} error{{ 's' if (level_counts.get('ERROR',0) + level_counts.get('CRITICAL',0)) != 1 else '' }}
  </span>
  {% endif %}
  {% if level_counts.get('WARNING') %}
  <span class="badge badge-warning">{{ level_counts['WARNING'] }} warning{{ 's' if level_counts['WARNING'] != 1 else '' }}</span>
  {% endif %}
  <span style="margin-left:auto;font-size:11px;color:var(--muted-foreground)">
    Page {{ page }} / {{ pages }}
  </span>
</div>

<div class="table-wrap">
  <table id="logTable">
    <thead>
      <tr>
        <th style="width:155px">Timestamp (UTC)</th>
        <th style="width:85px">Level</th>
        <th>Message</th>
      </tr>
    </thead>
    <tbody>
      {% for e in entries %}
      <tr class="log-row log-{{ e.level|lower }}">
        <td class="font-mono" style="font-size:11.5px;white-space:nowrap;color:var(--muted-foreground)">{{ e.ts }}</td>
        <td>
          {% if e.level in ('ERROR','CRITICAL') %}
          <span class="badge badge-danger">{{ e.level }}</span>
          {% elif e.level == 'WARNING' %}
          <span class="badge badge-warning">{{ e.level }}</span>
          {% elif e.level == 'INFO' %}
          <span class="badge badge-secondary">{{ e.level }}</span>
          {% else %}
          <span class="badge badge-secondary" style="opacity:.6">{{ e.level }}</span>
          {% endif %}
        </td>
        <td style="font-size:12.5px">
          <span class="log-msg">{{ e.msg }}</span>
          {% if e.extra %}
          <details style="margin-top:3px">
            <summary style="font-size:11px;color:var(--muted-foreground);cursor:pointer">+ {{ e.extra|length }} more line{{ 's' if e.extra|length != 1 else '' }}</summary>
            <pre style="font-size:11px;margin:4px 0 0;white-space:pre-wrap;color:var(--muted-foreground);line-height:1.4">{{ e.extra | join('\n') }}</pre>
          </details>
          {% endif %}
        </td>
      </tr>
      {% else %}
      <tr><td colspan="3" class="text-muted text-center" style="padding:32px">No log entries found.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

{% if pages > 1 %}
{% set qs = '&date=' + selected_date + ('&level=' + level_filter if level_filter else '') + ('&q=' + search_q if search_q else '') %}
<nav class="pagination" style="margin-top:14px">
  {% if page > 1 %}<a class="page-link" href="?page={{ page - 1 }}{{ qs }}">← Prev</a>{% endif %}
  {% set _s = [1, page - 3]|max %}
  {% set _e = [pages, page + 3]|min %}
  {% if _s > 1 %}<a class="page-link" href="?page=1{{ qs }}">1</a>{% if _s > 2 %}<span class="page-link disabled">…</span>{% endif %}{% endif %}
  {% for pn in range(_s, _e + 1) %}
  <a class="page-link {% if pn == page %}active{% endif %}" href="?page={{ pn }}{{ qs }}">{{ pn }}</a>
  {% endfor %}
  {% if _e < pages %}{% if _e < pages - 1 %}<span class="page-link disabled">…</span>{% endif %}<a class="page-link" href="?page={{ pages }}{{ qs }}">{{ pages }}</a>{% endif %}
  {% if page < pages %}<a class="page-link" href="?page={{ page + 1 }}{{ qs }}">Next →</a>{% endif %}
</nav>
{% endif %}

<style>
.log-row.log-error td,.log-row.log-critical td{background:color-mix(in oklch,var(--destructive) 6%,transparent)}
.log-row.log-warning td{background:color-mix(in oklch,oklch(0.76 0.18 80) 6%,transparent)}
.log-msg{word-break:break-word}
</style>
{% endblock %}
