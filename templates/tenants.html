{% extends "base.html" %}

{% block page_title %}Tenants{% endblock %}
{% block page_sub %}Multi-tenant overview &amp; management{% endblock %}

{% block topbar_actions %}
<a href="{{ url_for('wizard') }}" class="btn btn-primary btn-sm">
  <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
  Add Tenant
</a>
{% endblock %}

{% block content %}
<style>
.tenants-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(360px, 1fr));
  gap: 1.25rem;
}

.tenant-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: calc(var(--radius)*2);
  overflow: hidden;
  display: flex;
  flex-direction: column;
  transition: border-color 0.15s, box-shadow 0.15s;
}
.tenant-card:hover { border-color: oklch(0.38 0.008 265); box-shadow: 0 4px 24px rgba(0,0,0,.35); }
.tenant-card.inactive { opacity: .55; }

/* ── Card header ── */
.tc-header {
  padding: .85rem 1rem .75rem;
  display: flex;
  align-items: center;
  gap: .75rem;
  border-bottom: 1px solid var(--border);
}
.tc-avatar {
  width: 40px; height: 40px;
  border-radius: 10px;
  background: color-mix(in oklch, var(--primary) 18%, transparent);
  border: 1px solid color-mix(in oklch, var(--primary) 30%, transparent);
  display: flex; align-items: center; justify-content: center;
  flex-shrink: 0;
  color: var(--primary);
}
.tc-avatar svg { width: 20px; height: 20px; }

.tc-title { flex: 1; min-width: 0; }
.tc-title h3 {
  margin: 0 0 2px;
  font-size: .95rem; font-weight: 700;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  color: var(--foreground);
}
.tc-title .subdomain {
  font-size: .72rem; color: var(--muted-foreground);
  font-family: ui-monospace, monospace;
  display: flex; align-items: center; gap: 4px;
}
.tc-title .subdomain a {
  color: var(--primary); text-decoration: none;
}
.tc-title .subdomain a:hover { text-decoration: underline; }

.status-badge {
  font-size: .68rem; padding: 2px 9px; border-radius: 999px;
  font-weight: 600; white-space: nowrap;
  border: 1px solid transparent;
}
.badge-active   { background: color-mix(in oklch,var(--success) 15%,transparent); color: oklch(0.72 0.16 162); border-color: color-mix(in oklch,var(--success) 28%,transparent); }
.badge-inactive { background: color-mix(in oklch,var(--destructive) 15%,transparent); color: oklch(0.72 0.22 27); border-color: color-mix(in oklch,var(--destructive) 28%,transparent); }
.badge-uncfg    { background: color-mix(in oklch,var(--warning) 15%,transparent); color: oklch(0.82 0.16 70); border-color: color-mix(in oklch,var(--warning) 28%,transparent); }

/* ── Stats row ── */
.tc-stats {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  border-bottom: 1px solid var(--border);
}
.tc-stat {
  padding: .65rem .5rem;
  text-align: center;
  border-right: 1px solid var(--border);
}
.tc-stat:last-child { border-right: none; }
.tc-stat .value { font-size: 1.05rem; font-weight: 700; color: var(--foreground); }
.tc-stat .value.warn { color: var(--warning); }
.tc-stat .value.danger { color: var(--destructive); }
.tc-stat .label { font-size: .65rem; color: var(--muted-foreground); margin-top: 2px; text-transform: uppercase; letter-spacing: .03em; }

/* ── Last backup run ── */
.tc-backup-run {
  padding: .6rem 1rem;
  border-bottom: 1px solid var(--border);
  font-size: .72rem;
  color: var(--muted-foreground);
  line-height: 1.6;
}
.tc-backup-run .run-title {
  font-size: .7rem; font-weight: 600;
  color: var(--muted-foreground);
  text-transform: uppercase; letter-spacing: .04em;
  margin-bottom: 3px;
}
.tc-backup-run .run-line {
  display: flex; align-items: center; gap: 6px; flex-wrap: wrap;
}
.run-status {
  display: inline-flex; align-items: center; gap: 3px;
  font-size: .68rem; font-weight: 600; padding: 1px 7px;
  border-radius: 999px; border: 1px solid transparent;
}
.run-ok      { background: color-mix(in oklch,var(--success) 15%,transparent); color: oklch(0.72 0.16 162); border-color: color-mix(in oklch,var(--success) 28%,transparent); }
.run-warn    { background: color-mix(in oklch,var(--warning) 15%,transparent); color: oklch(0.82 0.16 70); border-color: color-mix(in oklch,var(--warning) 28%,transparent); }
.run-err     { background: color-mix(in oklch,var(--destructive) 15%,transparent); color: oklch(0.72 0.22 27); border-color: color-mix(in oklch,var(--destructive) 28%,transparent); }
.run-dot     { width: 5px; height: 5px; border-radius: 50%; background: var(--muted-foreground); display: inline-block; margin: 0 2px; vertical-align: middle; }

/* ── Flags ── */
.tc-flags {
  padding: .45rem 1rem;
  min-height: 26px;
  display: flex; flex-wrap: wrap; gap: .35rem; align-items: center;
  border-bottom: 1px solid var(--border);
}
.flag-pill {
  background: color-mix(in oklch,var(--destructive) 12%,transparent);
  color: oklch(0.72 0.22 27);
  border: 1px solid color-mix(in oklch,var(--destructive) 25%,transparent);
  font-size: .67rem; padding: 1px 8px; border-radius: 999px; font-weight: 600;
}
.no-flags { font-size: .72rem; color: oklch(0.65 0.15 162); }

/* ── Footer ── */
.tc-footer {
  padding: .6rem 1rem;
  display: flex; gap: .5rem; align-items: center;
  background: oklch(0.14 0.008 265);
}
.tc-footer .meta { font-size: .68rem; color: var(--muted-foreground); flex: 1; }

.empty-state {
  grid-column: 1 / -1;
  text-align: center;
  padding: 4rem 2rem;
  color: var(--muted-foreground);
}
.empty-state svg { width: 48px; height: 48px; margin: 0 auto 1rem; display: block; color: var(--border); }
.empty-state h3 { color: var(--foreground); margin: 0 0 .5rem; }
.empty-state p { font-size: .85rem; margin: 0 0 1.5rem; }
</style>

<div class="tenants-grid">
  {% if not cards %}
  <div class="empty-state">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
      <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
      <circle cx="9" cy="7" r="4"/>
      <path d="M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"/>
    </svg>
    <h3>No tenants yet</h3>
    <p>Use the Add Tenant wizard to connect your first Zendesk account.</p>
    <a href="{{ url_for('wizard') }}" class="btn btn-primary btn-sm">Add First Tenant</a>
  </div>
  {% endif %}

  {% for c in cards %}
  {% set br = c.last_backup_run %}
  <div class="tenant-card {% if not c.is_active %}inactive{% endif %}">

    {# ── Header ── #}
    <div class="tc-header">
      <div class="tc-avatar">
        {# Zendesk headset icon #}
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round">
          <path d="M3 18v-6a9 9 0 0 1 18 0v6"/>
          <path d="M21 19a2 2 0 0 1-2 2h-1a2 2 0 0 1-2-2v-3a2 2 0 0 1 2-2h3z"/>
          <path d="M3 19a2 2 0 0 0 2 2h1a2 2 0 0 0 2-2v-3a2 2 0 0 0-2-2H3z"/>
        </svg>
      </div>
      <div class="tc-title">
        <h3>{{ c.display_name }}</h3>
        <div class="subdomain">
          <a href="https://{{ c.zendesk_subdomain }}.zendesk.com" target="_blank" rel="noopener">
            {{ c.zendesk_subdomain }}.zendesk.com
          </a>
          {% if c.wasabi_bucket %}
          <span style="color:var(--border)">·</span>
          <span title="Wasabi bucket">{{ c.wasabi_bucket }}</span>
          {% endif %}
        </div>
      </div>
      {% if not c.configured %}
        <span class="status-badge badge-uncfg">Not Configured</span>
      {% elif c.is_active %}
        <span class="status-badge badge-active">Active</span>
      {% else %}
        <span class="status-badge badge-inactive">Inactive</span>
      {% endif %}
    </div>

    {# ── Stats ── #}
    <div class="tc-stats">
      <div class="tc-stat">
        <div class="value">{{ '{:,}'.format(c.tickets_processed) }}</div>
        <div class="label">Offloaded</div>
      </div>
      <div class="tc-stat">
        <div class="value">{{ '{:,}'.format(c.tickets_backed_up) }}</div>
        <div class="label">Backed Up</div>
      </div>
      <div class="tc-stat">
        <div class="value {% if c.errors_today > 5 %}danger{% elif c.errors_today > 0 %}warn{% endif %}">
          {{ c.errors_today }}
        </div>
        <div class="label">Errors</div>
      </div>
    </div>

    {# ── Last backup run ── #}
    <div class="tc-backup-run">
      <div class="run-title">Last Backup Run</div>
      {% if br %}
        {% set is_err = br.errors_count > 0 %}
        {% set status_clean = br.status | replace('_', ' ') %}
        <div class="run-line">
          <span>{{ br.run_date.strftime('%d-%m-%Y %H:%M') }} UTC</span>
          <span class="run-dot"></span>
          <span>scanned {{ '{:,}'.format(br.tickets_scanned) }}</span>
          <span class="run-dot"></span>
          <span>backed up {{ '{:,}'.format(br.tickets_backed_up) }}</span>
          <span class="run-dot"></span>
          <span>{{ '{:,}'.format(br.files_uploaded) }} files
            ({{ "%.1f"|format(br.bytes_uploaded / 1048576) }} MB)</span>
          {% if is_err %}
          <span class="run-dot"></span>
          <span style="color:oklch(0.72 0.22 27)">{{ br.errors_count }} error{{ 's' if br.errors_count != 1 }}</span>
          {% endif %}
          <span class="run-dot"></span>
          <span class="run-status {% if is_err %}run-warn{% else %}run-ok{% endif %}">
            {{ status_clean }}
          </span>
        </div>
      {% else %}
        <span style="color:var(--muted-foreground);font-style:italic">No backup runs yet</span>
      {% endif %}
    </div>

    {# ── Red flags ── #}
    <div class="tc-flags">
      {% if c.red_flags %}
        {% for flag in c.red_flags %}
          <span class="flag-pill">⚑ {{ flag }}</span>
        {% endfor %}
      {% else %}
        <span class="no-flags">✓ No issues</span>
      {% endif %}
    </div>

    {# ── Footer ── #}
    <div class="tc-footer">
      <div class="meta">
        {% if c.last_offload %}Last offload: {{ c.last_offload.strftime('%d %b %H:%M') }}{% else %}Never offloaded{% endif %}
      </div>
      <a href="{{ url_for('tenant_dashboard', slug=c.slug) }}" class="btn btn-primary btn-xs">Open</a>
      <a href="{{ url_for('tenant_settings', slug=c.slug) }}" class="btn btn-secondary btn-xs">Settings</a>
      <button class="btn btn-outline btn-xs" onclick="toggleTenant('{{ c.slug }}', this)">
        {{ 'Disable' if c.is_active else 'Enable' }}
      </button>
    </div>
  </div>
  {% endfor %}
</div>

<script>
async function toggleTenant(slug, btn) {
  btn.disabled = true;
  try {
    const r = await fetch(`/api/tenants/${slug}/toggle`, {method:'POST'});
    const d = await r.json();
    if (d.success) location.reload();
    else alert(d.message);
  } finally { btn.disabled = false; }
}
</script>
{% endblock %}
