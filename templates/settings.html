{% extends "base.html" %}
{% block title %}Settings — z2w{% endblock %}
{% block page_title %}Settings{% endblock %}
{% block page_sub %}Configure Zendesk, Wasabi, notifications and scheduler{% endblock %}
{% block topbar_actions %}
<button type="button" class="btn btn-primary btn-sm" onclick="document.getElementById('settingsForm').requestSubmit()">
  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
  Save Settings
</button>
{% endblock %}

{% block content %}
<form method="POST" id="settingsForm">
<div style="display:grid;grid-template-columns:1fr 1fr;gap:20px">

  <!-- Zendesk -->
  <div class="card">
    <div class="card-header"><div class="card-title">Zendesk Configuration</div></div>
    <div class="card-body">
      <div class="form-group"><label class="form-label">Subdomain</label><input type="text" class="form-control" name="ZENDESK_SUBDOMAIN" value="{{ settings.get('ZENDESK_SUBDOMAIN','') }}" placeholder="yourcompany"></div>
      <div class="form-group"><label class="form-label">Email</label><input type="email" class="form-control" name="ZENDESK_EMAIL" value="{{ settings.get('ZENDESK_EMAIL','') }}"></div>
      <div class="form-group"><label class="form-label">API Token</label><input type="password" class="form-control" name="ZENDESK_API_TOKEN" value="{{ settings.get('ZENDESK_API_TOKEN','') }}"></div>
      <div class="form-group"><label class="form-label">File Storage Limit (GB)</label><input type="number" step="0.1" class="form-control" name="ZENDESK_STORAGE_LIMIT_GB" value="{{ settings.get('ZENDESK_STORAGE_LIMIT_GB','') }}" placeholder="e.g. 130"><small style="color:var(--muted-foreground)">From Zendesk Admin → Account → File Storage. Used in reports.</small></div>
      <button type="button" class="btn btn-outline btn-sm" onclick="testConnection('zendesk')">Test Connection</button>
      <div id="zendesk-test-result" class="mt-2 text-sm"></div>
    </div>
  </div>

  <!-- Wasabi -->
  <div class="card">
    <div class="card-header"><div class="card-title">Wasabi B2 Configuration</div></div>
    <div class="card-body">
      <div class="form-group"><label class="form-label">Endpoint</label><input type="text" class="form-control" name="WASABI_ENDPOINT" value="{{ settings.get('WASABI_ENDPOINT','') }}" placeholder="s3.wasabisys.com"></div>
      <div class="form-group"><label class="form-label">Access Key</label><input type="text" class="form-control" name="WASABI_ACCESS_KEY" value="{{ settings.get('WASABI_ACCESS_KEY','') }}"></div>
      <div class="form-group"><label class="form-label">Secret Key</label><input type="password" class="form-control" name="WASABI_SECRET_KEY" value="{{ settings.get('WASABI_SECRET_KEY','') }}"></div>
      <div class="form-group"><label class="form-label">Bucket Name</label><input type="text" class="form-control" name="WASABI_BUCKET_NAME" value="{{ settings.get('WASABI_BUCKET_NAME','') }}"></div>
      <button type="button" class="btn btn-outline btn-sm" onclick="testConnection('wasabi')">Test Connection</button>
      <div id="wasabi-test-result" class="mt-2 text-sm"></div>
    </div>
  </div>

  <!-- Email -->
  <div class="card">
    <div class="card-header"><div class="card-title">Email / SMTP</div></div>
    <div class="card-body">
      <div class="form-group"><label class="form-label">SMTP Server</label><input type="text" class="form-control" name="SMTP_SERVER" value="{{ settings.get('SMTP_SERVER','smtp.gmail.com') }}"></div>
      <div class="form-row-2">
        <div class="form-group"><label class="form-label">Port</label><input type="number" class="form-control" name="SMTP_PORT" value="{{ settings.get('SMTP_PORT','587') }}"></div>
        <div class="form-group"><label class="form-label">Use TLS</label>
          <select class="form-select" name="SMTP_USE_TLS">
            <option value="true"  {% if settings.get('SMTP_USE_TLS','true') == 'true'  %}selected{% endif %}>Yes</option>
            <option value="false" {% if settings.get('SMTP_USE_TLS','true') == 'false' %}selected{% endif %}>No</option>
          </select>
        </div>
      </div>
      <div class="form-group"><label class="form-label">Username</label><input type="email" class="form-control" name="SMTP_USERNAME" value="{{ settings.get('SMTP_USERNAME','') }}"></div>
      <div class="form-group"><label class="form-label">Password</label><input type="password" class="form-control" name="SMTP_PASSWORD" value="{{ settings.get('SMTP_PASSWORD','') }}"></div>
      <div class="form-group"><label class="form-label">Report Recipients (comma-separated)</label><input type="text" class="form-control" name="REPORT_RECIPIENTS" value="{{ settings.get('REPORT_RECIPIENTS','') }}"></div>
    </div>
  </div>

  <!-- Telegram -->
  <div class="card">
    <div class="card-header"><div class="card-title">Telegram Notifications</div></div>
    <div class="card-body">
      <div class="form-group"><label class="form-label">Bot Token</label><input type="password" class="form-control" name="TELEGRAM_BOT_TOKEN" value="{{ settings.get('TELEGRAM_BOT_TOKEN','') }}"></div>
      <div class="form-group"><label class="form-label">Chat ID</label><input type="text" class="form-control" name="TELEGRAM_CHAT_ID" value="{{ settings.get('TELEGRAM_CHAT_ID','') }}"></div>
      <button type="button" class="btn btn-outline btn-sm" onclick="testConnection('telegram')">Test</button>
      <div id="telegram-test-result" class="mt-2 text-sm"></div>
    </div>
  </div>

  <!-- Slack -->
  <div class="card">
    <div class="card-header"><div class="card-title">Slack Notifications</div></div>
    <div class="card-body">
      <div class="form-group"><label class="form-label">Webhook URL</label><input type="password" class="form-control" name="SLACK_WEBHOOK_URL" value="{{ settings.get('SLACK_WEBHOOK_URL','') }}"></div>
      <button type="button" class="btn btn-outline btn-sm" onclick="testConnection('slack')">Test</button>
      <div id="slack-test-result" class="mt-2 text-sm"></div>
    </div>
  </div>

  <!-- Scheduler -->
  <div class="card">
    <div class="card-header"><div class="card-title">Scheduler</div></div>
    <div class="card-body">
      <div class="form-group"><label class="form-label">Offload Time (HH:MM, server time)</label><input type="text" class="form-control" name="OFFLOAD_TIME" value="{{ settings.get('OFFLOAD_TIME','00:00') }}" placeholder="00:00"></div>
      <div class="form-group"><label class="form-label">Recheck Time (HH:MM)</label><input type="text" class="form-control" name="RECHECK_TIME" value="{{ settings.get('RECHECK_TIME','01:00') }}" placeholder="01:00"></div>
      <div class="form-group"><label class="form-label">Storage Report Interval (hours)</label><input type="number" class="form-control" name="STORAGE_REPORT_INTERVAL" value="{{ settings.get('STORAGE_REPORT_INTERVAL','6') }}" min="1" max="168"></div>
      <div class="form-group"><label class="form-label">Max Attachments per Run</label><input type="number" class="form-control" name="MAX_ATTACHMENTS_PER_RUN" value="{{ settings.get('MAX_ATTACHMENTS_PER_RUN','') }}" placeholder="unlimited"></div>
    </div>
  </div>

  {% if oauth_settings %}
  <!-- OAuth / SSO -->
  <div class="card" style="grid-column:1/-1">
    <div class="card-header"><div class="card-title">Microsoft OAuth / SSO</div></div>
    <div class="card-body">
      <div class="form-row-3">
        <div class="form-group"><label class="form-label">Client ID</label><input type="text" class="form-control" name="OAUTH_CLIENT_ID" value="{{ settings.get('OAUTH_CLIENT_ID','') }}"></div>
        <div class="form-group"><label class="form-label">Client Secret</label><input type="password" class="form-control" name="OAUTH_CLIENT_SECRET" value="{{ settings.get('OAUTH_CLIENT_SECRET','') }}"></div>
        <div class="form-group"><label class="form-label">Tenant ID</label><input type="text" class="form-control" name="OAUTH_TENANT_ID" value="{{ settings.get('OAUTH_TENANT_ID','') }}"></div>
      </div>
      <div class="form-group"><label class="form-label">Allowed Domains (comma-separated, blank = any)</label><input type="text" class="form-control" name="OAUTH_ALLOWED_DOMAINS" value="{{ settings.get('OAUTH_ALLOWED_DOMAINS','') }}"></div>
    </div>
  </div>
  {% endif %}

</div><!-- end grid -->

<div class="mt-4 flex gap-2">
  <button type="submit" class="btn btn-primary">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/></svg>
    Save Settings
  </button>
</div>
</form>

<script>
function testConnection(type) {
  const el = document.getElementById(type + '-test-result');
  el.textContent = 'Testing…';
  el.style.color = 'var(--muted-foreground)';
  fetch('/api/test_connection/' + type, {method:'POST'})
    .then(r=>r.json())
    .then(d=>{
      el.textContent = d.message;
      el.style.color = d.success ? 'var(--success)' : 'var(--destructive)';
    }).catch(()=>{ el.textContent='Request failed'; el.style.color='var(--destructive)'; });
}
</script>
{% endblock %}
